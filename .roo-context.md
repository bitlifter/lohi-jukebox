# Project Context: Jukebox Escape Room Automation

## 1. Project Overview and Goals

*   **Project:** Integrate a 1953 EMI jukebox into an escape room art project.
*   **Hardware:** Raspberry Pi Zero 2 W running Node-RED 4.0.9, 4x 1185RE8 microswitches (main inputs), 1x 1185RE8 microswitch (manual reset).
*   **Core Goal:** When each of the four main physical buttons is pressed at least once, Node-RED will trigger the playback of a specific MP3 file (`/home/admin/Music/mystery_unlocked.mp3`).
*   **Additional Goal:** A fifth button will manually reset the system, requiring all four main buttons to be pressed again. The system also automatically resets after successful MP3 playback.

## 2. Current Status and Completed Work

*   **Phase:** Implementation completed.
*   **Key Decisions & Plans:**
    *   **Node-RED Flow Logic:** Defined, including input handling, state management, conditional triggering, and reset mechanisms.
    *   **GPIO & Wiring:**
        *   Switches (1185RE8): COM terminal to Pi GND, NO terminal to chosen GPIO input pin.
        *   Raspberry Pi: Internal pull-up resistors to be enabled via the `rpi-gpio in` node configuration.
        *   Suggested GPIOs: GPIO17, GPIO27, GPIO22, GPIO5 for main buttons; GPIO6 for reset (flexible).
    *   **Switch Debouncing:** Handled using `delay` nodes in Node-RED (rate limit mode, e.g., 1 message/second).
    *   **State Management:** Node-RED flow context variables (`flow.buttonXPressed`) to track button states, initialized on deploy.
    *   **MP3 Playback:** Via Node-RED `exec` node calling a command-line player (e.g., `mpg123 /home/admin/Music/mystery_unlocked.mp3`).
    *   **Reset:** Both manual (via dedicated button) and automatic (after MP3 playback) reset of button states.
*   **Artifacts Created:**
    *   [`node-red-jukebox-flow.json`](node-red-jukebox-flow.json): Complete Node-RED flow implementation.
    *   [`test_gpio_buttons.py`](test_gpio_buttons.py): Python script for testing GPIO connections.
    *   [`setup.sh`](setup.sh): Installation script for dependencies.
    *   [`README.md`](README.md): Main documentation and setup instructions.
    *   [`TROUBLESHOOTING.md`](TROUBLESHOOTING.md): Detailed troubleshooting guide.
    *   [`wiring_diagram.txt`](wiring_diagram.txt): Text-based wiring diagram.
    *   [`PROJECT_STRUCTURE.md`](PROJECT_STRUCTURE.md): Project organization overview.
    *   [`mermaid-diagram.md`](mermaid-diagram.md): Visual representation of the Node-RED flow.
    *   [`node-red-jukebox-plan.md`](node-red-jukebox-plan.md): Detailed textual description of the plan.

## 3. Known Issues or Constraints

*   **Physical Setup:** The actual physical integration of the jukebox, Raspberry Pi, and wiring is outside the scope of this digital planning but is a prerequisite for testing.
*   **Software Dependencies:** The command-line MP3 player (e.g., `mpg123`) must be installed and working on the Raspberry Pi. The `setup.sh` script handles this installation.
*   **Node-RED Version:** User specified Node-RED 4.0.9. Node compatibility should be fine but is a consideration.
*   **GPIO Pin Finalization:** Suggested GPIO pins are placeholders; actual pins used during implementation might vary based on convenience. The implementation allows for easy pin reconfiguration.
*   **Testing Environment:** The implementation has been created but not physically tested on actual hardware.

## 4. Next Planned Tasks

1.  **Physical Implementation:**
    *   Set up the Raspberry Pi Zero 2 W with Node-RED 4.0.9.
    *   Run the `setup.sh` script to install all dependencies.
    *   Connect the microswitches to the Raspberry Pi GPIO pins as per the wiring diagram.

2.  **Software Deployment:**
    *   Import the `node-red-jukebox-flow.json` into Node-RED.
    *   Deploy the flow and verify it loads correctly.

3.  **Testing:**
    *   Run the `test_gpio_buttons.py` script to verify GPIO connections.
    *   Test the Node-RED flow with physical button presses.
    *   Verify MP3 playback when all buttons are pressed.
    *   Test the manual reset functionality.
    *   Verify automatic reset after MP3 playback.

4.  **Integration with Jukebox:**
    *   Integrate the tested system with the 1953 EMI jukebox.
    *   Ensure proper mounting and connection of microswitches.
    *   Test the complete integrated system.

5.  **Refinement:**
    *   Adjust debounce timings if needed based on real-world testing.
    *   Fine-tune any aspects of the system based on testing results.